# KMarket Demo å¼€å‘å®žæ–½æ–‡æ¡£ (MVP)

> **ç›®æ ‡**: å¿«é€Ÿæž„å»ºä¸€ä¸ªåŸºäºŽ Polygon çš„ K çº¿é¢„æµ‹å¸‚åœº MVP (Minimum Viable Product)ã€‚
> **æ ¸å¿ƒæž¶æž„å˜æ›´**: é‰´äºŽç§’çº§é«˜é¢‘ä¸‹æ³¨éœ€æ±‚ï¼Œé‡‡ç”¨ **"é“¾ä¸‹æ’®åˆ + é“¾ä¸Šèµ„é‡‘æ‰˜ç®¡"** çš„ Layer 2 æ··åˆæž¶æž„ã€‚ç”¨æˆ·å……å€¼åŽï¼Œä¸‹æ³¨åªéœ€ç­¾åï¼ˆæ— éœ€ Gasï¼‰ï¼Œç»“ç®—åœ¨æœåŠ¡å™¨ç«¯å®Œæˆï¼ŒæçŽ°æ—¶éªŒè¯æœåŠ¡å™¨ç­¾åä¸Šé“¾ã€‚

## 1. æŠ€æœ¯æž¶æž„æ–¹æ¡ˆ (Hybrid Model)

ä¸ºäº†æ»¡è¶³é«˜é¢‘ä½“éªŒï¼Œæˆ‘ä»¬é‡‡ç”¨ä»¥ä¸‹æµç¨‹ï¼š

1.  **å……å€¼ (On-Chain)**: ç”¨æˆ·å°† USDC å……å…¥æ™ºèƒ½åˆçº¦ (`Vault`)ã€‚
2.  **ä¸‹æ³¨ (Off-Chain)**: ç”¨æˆ·åœ¨å‰ç«¯å¯¹ä¸‹æ³¨æ•°æ®è¿›è¡Œ **EIP-712 ç­¾å**ï¼Œå‘é€ç»™åŽç«¯ã€‚
3.  **æ’®åˆä¸Žè®°è´¦ (Off-Chain)**: åŽç«¯æœåŠ¡å™¨éªŒè¯ç­¾åï¼Œæ‰£é™¤ç”¨æˆ·æ•°æ®åº“ä½™é¢ï¼Œè®°å½•ä¸‹æ³¨ã€‚
4.  **ç»“ç®— (Off-Chain)**: åŽç«¯æ ¹æ®å®žæ—¶ K çº¿æ•°æ®ï¼ˆBinance/Coinbase WSï¼‰åˆ¤å®šè¾“èµ¢ï¼Œæ›´æ–°æ•°æ®åº“ä½™é¢ã€‚
5.  **æçŽ° (On-Chain)**: ç”¨æˆ·è¯·æ±‚æçŽ° -> åŽç«¯ç”Ÿæˆå¸¦æœ‰æœåŠ¡å™¨ç§é’¥ç­¾åçš„å‡­è¯ (Coupon) -> ç”¨æˆ·è°ƒç”¨åˆçº¦æçŽ° -> åˆçº¦éªŒè¯ç­¾åå¹¶æ”¾æ¬¾ã€‚

---

## 2. è¯¦ç»†åˆ†å·¥ä¸Žä»»åŠ¡åˆ—è¡¨

### ðŸŸ¢ ç¬¬ä¸€éƒ¨åˆ†ï¼šSmart Contracts (æ™ºèƒ½åˆçº¦)

**ç›®æ ‡**: ç¡®ä¿èµ„é‡‘å®‰å…¨ï¼Œæä¾›å……å€¼å…¥å£å’Œç»è¿‡éªŒè¯çš„æçŽ°å‡ºå£ã€‚

**å¼€å‘ä»»åŠ¡**:

1.  **`KMarketVault.sol` (èµ„é‡‘æ± åˆçº¦)**
    *   [ ] **Deposit**: æŽ¥æ”¶ç”¨æˆ· USDCï¼Œæ˜ å°„åˆ°é“¾ä¸‹è´¦æˆ·ï¼ˆé€šè¿‡ Event é€šçŸ¥åŽç«¯ï¼‰ã€‚
    *   [ ] **Withdraw**: æ ¸å¿ƒåŠŸèƒ½ã€‚éœ€è¦éªŒè¯åŽç«¯ç­¾å‘çš„ `WithdrawCoupon`ã€‚
        *   å‚æ•°: `amount`, `nonce`, `expiry`, `serverSignature`ã€‚
        *   é€»è¾‘: éªŒè¯ `ecrecover` ç­¾åè€…æ˜¯å¦ä¸º `Manager` è®¾å®šçš„æœåŠ¡å™¨å…¬é’¥ï¼›é˜²æ­¢é‡æ”¾æ”»å‡» (Nonce)ã€‚
    *   [ ] **EmergencyWithdraw**: ç´§æ€¥æš‚åœå’Œç®¡ç†å‘˜ææ¬¾ï¼ˆä»…ç”¨äºŽ Demo é˜¶æ®µé£ŽæŽ§ï¼‰ã€‚

2.  **`LiquidityManager.sol` (ç®€åŒ–ç‰ˆ LP ç®¡ç†)**
    *   [ ] ç®€å•å®žçŽ° LP å……å€¼å’Œæå–ï¼ŒDemo é˜¶æ®µå¯ä»¥å°†æ‰€æœ‰å……å€¼ç”¨æˆ·è§†ä¸ºåŒä¸€æ± å­ï¼Œæˆ–è€…ç”±é¡¹ç›®æ–¹åšå”¯ä¸€çš„ LPã€‚

**äº¤ä»˜ç‰©**:
*   Solidity æºç 
*   Hardhat éƒ¨ç½²è„šæœ¬
*   åˆçº¦ ABI æ–‡ä»¶ (ä¾›å‰/åŽç«¯ä½¿ç”¨)

---

### ðŸ”µ ç¬¬äºŒéƒ¨åˆ†ï¼šBackend API & Engine (åŽç«¯å¼•æ“Ž)

**ç›®æ ‡**: å¤„ç†é«˜é¢‘ä¸‹æ³¨ä¸šåŠ¡ï¼Œç»´æŠ¤ç”¨æˆ·ä½™é¢ï¼Œå¯¹æŽ¥è¡Œæƒ…ã€‚

**æŠ€æœ¯æ ˆ**: Node.js (NestJS/Express) + PostgreSQL + Redis (ç”¨äºŽé”å’Œç¼“å­˜)ã€‚

**å¼€å‘ä»»åŠ¡**:

1.  **è¡Œæƒ…æœåŠ¡ (Price Service)**
    *   [ ] **Websocket Listener**: è¿žæŽ¥ Binance/OKX çš„ ETH/USDT çŽ°è´§ WebSocketï¼ŒèŽ·å–ç§’çº§ä»·æ ¼ã€‚
    *   [ ] **Price Store**: å°†æ¯ç§’ä»·æ ¼å­˜å…¥ Redis/DBï¼Œç”¨äºŽç»“ç®—åˆ¤å®šã€‚

2.  **è´¦æˆ·ç³»ç»Ÿ (Account System)**
    *   [ ] **DB Schema**: è®¾è®¡ `UserBalance`, `BetHistory`, `Transactions` è¡¨ã€‚
    *   [ ] **Deposit Syncer**: ç›‘å¬é“¾ä¸Š `Deposit` äº‹ä»¶ï¼Œè‡ªåŠ¨å¢žåŠ æ•°æ®åº“ä¸­ç”¨æˆ·çš„ä½™é¢ã€‚
    *   [ ] **Withdraw Signer**: æŽ¥å£ `POST /withdraw-request`ã€‚éªŒè¯ç”¨æˆ·ä½™é¢å……è¶³åŽï¼Œæ‰£é™¤ä½™é¢ï¼Œä½¿ç”¨æœåŠ¡å™¨ç§é’¥å¯¹æçŽ°æ•°æ®ç­¾åï¼Œè¿”å›žç­¾åç»™å‰ç«¯ã€‚

3.  **äº¤æ˜“å¼•æ“Ž (Trade Engine)**
    *   [ ] **Bet API**: `POST /bet`ã€‚æŽ¥æ”¶ç”¨æˆ· EIP-712 ç­¾åã€‚
        *   éªŒè¯ç­¾åæœ‰æ•ˆæ€§ã€‚
        *   éªŒè¯ä½™é¢å……è¶³ã€‚
        *   éªŒè¯èµ”çŽ‡å’Œ Tick æ˜¯å¦è¿‡æœŸï¼ˆå¦‚ï¼šä»·æ ¼å·²è¶…å‡ºå…è®¸èŒƒå›´ï¼‰ã€‚
        *   å…¥åº“å¹¶å†»ç»“èµ„é‡‘ã€‚
    *   [ ] **Settlement Worker**: å®šæ—¶ä»»åŠ¡ï¼ˆæ¯ç§’æ£€æŸ¥ï¼‰ã€‚
        *   æ‰«æå·²åˆ°æœŸçš„ä¸‹æ³¨ã€‚
        *   å¯¹æ¯”å½“å‰ä»·æ ¼å’Œä¸‹æ³¨ Tickã€‚
        *   åˆ¤å®šè¾“èµ¢ï¼Œæ›´æ–°ç”¨æˆ·ä½™é¢ï¼ˆè¿”è¿˜æœ¬é‡‘+å¥–é‡‘ æˆ– æ²¡æ”¶æœ¬é‡‘ï¼‰ã€‚

**äº¤ä»˜ç‰©**:
*   RESTful API æŽ¥å£æ–‡æ¡£
*   å¯è¿è¡Œçš„åŽç«¯æœåŠ¡
*   æ•°æ®åº“ SQL åˆå§‹åŒ–è„šæœ¬

---

### ðŸŸ  ç¬¬ä¸‰éƒ¨åˆ†ï¼šFrontend (å‰ç«¯äº¤äº’)

**ç›®æ ‡**: ç»™ç”¨æˆ·æ— éœ€ Gas çš„ä¸æ»‘ä¸‹æ³¨ä½“éªŒã€‚

**æŠ€æœ¯æ ˆ**: Next.js + Wagmi/Viem + Tailwind.

**å¼€å‘ä»»åŠ¡**:

1.  **Web3 åŸºç¡€**
    *   [ ] é’±åŒ…è¿žæŽ¥ (MetaMask, RainbowKit)ã€‚
    *   [ ] é¡µé¢é¡¶éƒ¨æ˜¾ç¤ºï¼šé“¾ä¸Šä½™é¢ (Vault) vs å¯ç”¨ä½™é¢ (App Balance)ã€‚
    *   [ ] å……å€¼/æçŽ°å¼¹çª—ï¼šè°ƒç”¨åˆçº¦å……å€¼ï¼›è¯·æ±‚åŽç«¯ç­¾ååŽè°ƒç”¨åˆçº¦æçŽ°ã€‚

2.  **K çº¿å›¾è¡¨ (Chart)**
    *   [ ] é›†æˆ **TradingView Lightweight Charts**ã€‚
    *   [ ] å¯¹æŽ¥åŽç«¯ WebSocket æŽ¨é€çš„å®žæ—¶ä»·æ ¼ï¼Œç¡®ä¿å›¾è¡¨ä¸Žç»“ç®—ä»·æ ¼ä¸€è‡´ã€‚
    *   [ ] **ç‰¹è‰²åŠŸèƒ½**: åœ¨ K çº¿å›¾ä¸Šç”»çº¿å¯è§†åŒ–ç”¨æˆ·çš„ Tick åŒºé—´ï¼ˆå¦‚åœ¨å½“å‰ä»·æ ¼ä¸Šä¸‹ç”»å‡ºç»¿è‰²/çº¢è‰²åŒºåŸŸï¼‰ã€‚

3.  **äº¤æ˜“é¢æ¿ (Trading Panel)**
    *   [ ] **æ—¶é—´é€‰æ‹©**: TAB åˆ‡æ¢ (30s, 1m, 5m)ã€‚
    *   [ ] **é‡‘é¢è¾“å…¥**: è¾“å…¥ä¸‹æ³¨ USDC æ•°é‡ã€‚
    *   [ ] **Tick é€‰æ‹©**: æ‹–åŠ¨æ»‘å—æˆ–è¾“å…¥ç™¾åˆ†æ¯”é€‰æ‹©é¢„æµ‹åŒºé—´ã€‚
    *   [ ] **èµ”çŽ‡å±•ç¤º**: æ ¹æ®å½“å‰ Tick å’Œæ—¶é—´ï¼Œå®žæ—¶æ˜¾ç¤ºåŽç«¯è®¡ç®—çš„èµ”çŽ‡ã€‚
    *   [ ] **ä¸‹å•æŒ‰é’®**: ç‚¹å‡»è§¦å‘ `signTypedData` (ç­¾å)ï¼Œè€Œéžå‘é€äº¤æ˜“ã€‚

4.  **æˆ‘çš„è®¢å• (Positions)**
    *   [ ] å€’è®¡æ—¶å±•ç¤ºï¼šå±•ç¤ºè¿›è¡Œä¸­çš„ä¸‹æ³¨å‰©ä½™æ—¶é—´ã€‚
    *   [ ] åŽ†å²è®°å½•ï¼šå±•ç¤ºè¾“èµ¢ç»“æžœã€‚

**äº¤ä»˜ç‰©**:
*   Next.js æºç 
*   Vercel é¢„è§ˆåœ°å€

---

### ðŸŸ£ ç¬¬å››éƒ¨åˆ†ï¼šUI/UX Design (ç•Œé¢è®¾è®¡)

**ç›®æ ‡**: è®¾è®¡ç›´è§‚ã€ä¸“ä¸šçš„äº¤æ˜“ç•Œé¢ã€‚

**è®¾è®¡ä»»åŠ¡**:

1.  **å¸ƒå±€è®¾è®¡**
    *   **å·¦ä¾§ (70%)**: å¤§å¹… K çº¿å›¾ã€‚è¿™æ˜¯ç”¨æˆ·è§†çº¿ç„¦ç‚¹ã€‚
    *   **å³ä¾§ (30%)**: äº¤æ˜“æ“ä½œåŒºã€‚åŒ…å« Tab åˆ‡æ¢ï¼ˆæ¶¨/è·Œ/åŒºé—´ï¼‰ã€é‡‘é¢ã€ç¡®è®¤æŒ‰é’®ã€‚
    *   **åº•éƒ¨**: æŒä»“åˆ—è¡¨å’ŒåŽ†å²è®°å½•ã€‚

2.  **è§†è§‰äº¤äº’**
    *   [ ] **Tick å¯è§†åŒ–**: è®¾è®¡å½“ç”¨æˆ·åœ¨å³ä¾§è°ƒæ•´â€œåŒºé—´â€æ—¶ï¼Œå·¦ä¾§ K çº¿å›¾ä¸Šé«˜äº®å¯¹åº”çš„ä»·æ ¼å¸¦ã€‚è¿™æ˜¯æ ¸å¿ƒä½“éªŒã€‚
    *   [ ] **å€’è®¡æ—¶åŠ¨æ•ˆ**: ä¸‹æ³¨åŽçš„å€’è®¡æ—¶è¿›åº¦æ¡ï¼Œå¢žåŠ ç´§å¼ åˆºæ¿€æ„Ÿã€‚
    *   [ ] **ç»“æžœåé¦ˆ**: ç»“ç®—çž¬é—´çš„ èµ¢(ç»¿è‰²)/è¾“(ç°è‰²) åŠ¨ç”»æ•ˆæžœã€‚

**äº¤ä»˜ç‰©**:
*   Figma åŽŸåž‹å›¾ (é«˜ä¿çœŸ)
*   UI åˆ‡å›¾èµ„æº

---

## 3. Demo å¼€å‘æµç¨‹å›¾

```mermaid
sequenceDiagram
    participant User
    participant Frontend
    participant Contract (Polygon)
    participant Backend
    participant EventListener

    Note over User, Backend: é˜¶æ®µ 1: å……å€¼
    User->>Frontend: ç‚¹å‡»å……å€¼ 100 USDC
    Frontend->>Contract: è°ƒç”¨ deposit(100)
    Contract-->>EventListener: Emit DepositEvent
    EventListener->>Backend: ç›‘å¬åˆ°å……å€¼
    Backend->>Backend: DB: User Balance + 100

    Note over User, Backend: é˜¶æ®µ 2: é«˜é¢‘ä¸‹æ³¨
    User->>Frontend: é€‰æ‹©åŒºé—´ï¼Œç‚¹å‡»ä¸‹æ³¨
    Frontend->>Frontend: å¼¹å‡ºç­¾å (EIP-712)
    User->>Frontend: ç¡®è®¤ç­¾å (No Gas)
    Frontend->>Backend: å‘é€ç­¾å + ä¸‹æ³¨æ•°æ®
    Backend->>Backend: éªŒç­¾ & æ‰£æ¬¾ & è®°å½•è®¢å•
    loop æ¯ç§’æ£€æµ‹
        Backend->>Backend: èŽ·å–æœ€æ–°ä»·æ ¼ -> åˆ¤å®šè¾“èµ¢ -> åŠ å¸
    end

    Note over User, Backend: é˜¶æ®µ 3: æçŽ°
    User->>Frontend: è¯·æ±‚æçŽ°
    Frontend->>Backend: API: Get Withdraw Signature
    Backend->>Backend: éªŒè¯ä½™é¢ -> ç”Ÿæˆç§é’¥ç­¾å
    Backend-->>Frontend: è¿”å›ž {v, r, s, amount, nonce}
    Frontend->>Contract: è°ƒç”¨ withdrawWithSig(...)
    Contract->>Contract: ecrecover éªŒè¯ç­¾å -> è½¬è´¦ USDC
```
