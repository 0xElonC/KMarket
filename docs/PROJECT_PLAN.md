# KMarket - K线预测市场项目企划书

## 1. 项目概述

### 1.1 项目简介
KMarket 是建立在 Polygon 区块链上的去中心化金融（DeFi）衍生品协议，专注于将任何可被量化的、被追踪的数据都可以被线图化，可与预测化。不同于传统的二元期权或永续合约，KMarket 创新性地引入了类似 Uniswap V3 的"Tick（刻度）"机制，允许用户对未来特定时间段内的价格区间进行精准预测。

通过将流动性做市与预测市场相结合，KMarket 为交易者提供了一种风险可控、回报透明的新型博弈工具，同时也为流动性提供者（LP）创造了不仅限于交易手续费的多元化收益来源。项目采用类似 Polymarket 的资金管理模式，确保资金流转的透明与安全。

### 1.2 市场痛点
当前加密货币衍生品市场主要由永续合约和期权主导，但它们存在一定的局限性：
- **预测市场过于简单**：Polymarket 等平台仅支持"是/否"二元结果，无法捕捉数值变化的精细程度。
- **衍生品风险过高**：永续合约的高杠杆和爆仓机制让普通用户望而却步。
- **数据孤岛严重**：政治、体育、娱乐等领域的预测分散在不同平台，缺乏统一的交易体验。
- **流动性激励不足**：传统平台往往是用户与庄家对赌，缺乏透明的流动性提供机制。

### 1.3 解决方案
KMarket 提出了一套基于区间的价格预测方案：
- **万物线图化引擎**：将任何可量化数据转化为标准 K 线格式，提供统一的交易界面。
- **Tick 区间预测**：用户预测数值将落入哪个区间，而非简单的涨跌方向。
- **动态赔率机制**：赔率根据市场供需和概率模型自动计算，距离当前值越远，赔率越高。
- **去中心化流动性池**：LP 可以向特定区间注入流动性，获得手续费和失败预测的本金分红。
- **无爆仓风险**：最大损失仅限于下注本金，不会因数据波动而被强制平仓。

### 1.4 核心特性
1. **万物皆可线**：统一的数据线图化引擎，支持任意可量化事件。
2. **Tick 区间预测**：精细化的数值区间划分，提供丰富的策略维度。
3. **动态赔率系统**：距离当前值越远，潜在回报越高。
4. **多周期支持**：从 30 秒极速市场到月度长线预测，满足不同需求。
5. **链上透明结算**：所有数据上链，结果由预言机自动判定。

### 1.5 目标用户
- **加密货币交易者**：寻找新型博弈工具的 DeFi 原生用户。
- **体育博彩爱好者**：希望用更透明、更灵活方式参与体育预测的用户。
- **政治/时事关注者**：对选举、政策等事件有独到见解的预测者。
- **流动性提供者**：寻求比传统 AMM 更高收益率的 DeFi 挖矿者。
- **量化交易团队**：利用概率模型进行套利和对冲的专业机构。

## 2. 核心机制设计

### 2.1 价格区间（Tick）机制

借鉴 Uniswap V3 的设计理念：
- **基础区间**：将价格波动幅度标准化，例如每 1% 作为一个最小 Tick 单位。
- **当前价格锚点**：以市场开启时的预言机价格为基准（例如 ETH = $2900）。
- **Tick 编号系统**：正数表示看涨区间，负数表示看跌区间。
  - Tick +1: $2929 - $2958 (+1% ~ +2%)
  - Tick +2: $2958 - $2987 (+2% ~ +3%)
  - Tick -1: $2871 - $2900 (-1% ~ 0%)
  - Tick -2: $2842 - $2871 (-2% ~ -1%)

### 2.2 赔率计算公式

**基础赔率模型**：
```
赔率 = 1 + (基础利率 * 距离系数 * 流动性调整系数 * 时间风险系数)

其中：
- 基础利率：固定参数，例如 0.3 (30%)
- 时间风险系数：根据时间间隔设定，时间越短波动越剧烈，风险系数越高，赔率相应调整。
- 距离系数 = |Tick 编号| * 距离权重
- 流动性调整系数 = 总流动性 / (Tick 流动性 + epsilon)
```

**示例**：
- Tick +1 (距离 1%): 赔率约 1.3
- Tick +3 (距离 3%): 赔率约 1.9
- Tick +5 (距离 5%): 赔率约 2.5
- Tick +10 (距离 10%): 赔率约 4.0

### 2.3 市场结算机制

本平台专注于超短周期的价格预测，最长周期不超过 1 小时：
- **极速市场**：30 秒、60 秒（1 分钟），适合高频快进快出。
- **短时市场**：5 分钟、15 分钟、30 分钟，适合短线趋势判断。
- **常规市场**：60 分钟（1 小时），为平台支持的最长周期。

市场采用滚动开启模式（Rolling），例如 1 分钟市场每分钟开启一轮新的预测 08:00 等时刻开启。
- **24 小时市场**：每日 00:00 UTC 开启。

**价格预言机**：
- 采用 Chainlink Price Feed 获取可信的链下价格。
- 结算价格锁定：以市场结束时刻的预言机价格为准。
- 安全时间窗口：允许结算后 15 分钟内的宽限期以处理网络延迟。

**结算规则**：
```solidity
if (结算价格 >= tick上界) {
    // 该 Tick 的多头投注者获胜
    赢家分配 = 本金 * 赔率
} else if (结算价格 < tick下界) {
    // 该 Tick 的投注者失败
    本金归入流动性池
} else {
    // 价格在 Tick 范围内但未达到完全获胜条件（可选规则）
    // 按比例返还部分资金或判定为负
}
```

### 2.4 流动性提供机制

**LP 收益来源**：
1.  **手续费收入**：每笔用户下注收取 2-3% 的协议手续费。
2.  **对手方收益**：用户预测失败后的本金将注入流动性池，作为 LP 的回报。
3.  **时间衰减费**：对长期未提取的闲置奖金收取的管理费用。

**LP 风险**：
- **赔付风险**：当大量用户预测正确时，流动性池需要支付高额奖金。
- **资金占用**：在市场活跃期间，部分流动性可能被锁定。
- **尾部风险**：极端单边行情可能导致局部流动性枯竭。

**LP 代币（LP Token）**：
- 用户存入 USDT/USDC/ETH 等资产提供流动性，获得 LP Token 凭证。
- LP Token 代表池中资产的份额，可随时赎回（需满足锁定期要求）。
- LP Token 设计兼容 ERC-20 标准，支持在二级市场流通。

## 3. 技术架构

### 3.1 整体架构图

### 3.1 整体架构（Layer 2 混合模式）

为了满足秒级高频预测的需求，KMarket 采用 **"链下撮合、链上结算"** 的 Layer 2 混合架构。

```
┌─────────────────────────────────────────────────────┐
│                    用户端 (Client)                    │
│  - 钱包签名 (EIP-712)                                 │
│  - 实时 WebSocket 交互                                │
└──────────┬───────────────────────────────▲──────────┘
           │ (1. 签名下注)                   │ (2. 状态更新)
           ▼                               │
┌─────────────────────────────────────────────────────┐
│                 链下定序器 (Sequencer)                │
│  - 撮合引擎 & 风险控制                                 │
│  - 虚拟账本 (Virtual Ledger)                          │
│  - 预言机监听 (Binance/Chainlink 高频 API)            │
└──────────┬───────────────────────────────▲──────────┘
           │ (3. 提交结算根 / 提现凭证)       │ (4. 验证存款)
           ▼                               │
┌─────────────────────────────────────────────────────┐
│                Polygon 链上合约层                     │
│  - 资金托管合约 (Vault)                               │
│  - 验证与结算合约 (Verifier)                          │
│  - 流动性池合约 (LP Pool)                             │
└─────────────────────────────────────────────────────┘
```

### 3.2 智能合约架构

#### 3.2.1 核心合约模块

1.  **LiquidityVault.sol (资金库)**
    - 负责即时的充值（Deposit）和提现（Withdraw）。
    - 维护 LP 资金池和用户托管资金的总量。
    - **核心逻辑**：只有持有有效"提现凭证"的请求才能转出资金。

2.  **MarketVerifier.sol (验证器)**
    - 验证定序器的签名。
    - 处理用户的"强制提现"（Force Exit）请求（防止定序器作恶）。
    - 记录定序器上传的状态根（State Root），用于数据可用性检查。

3.  **LPManager.sol (流动性管理)**
    - 允许 LP 存入资金铸造 LP Token。
    - 计算协议层面的盈亏分红。

#### 3.2.2 交互流程 (Sign-to-Trade)

**1. 充值流程 (On-chain)**
- 用户向 `LiquidityVault` 转账 USDC。
- 合约发出 `Deposit` 事件。
- **定序器** 监听到事件，在用户的链下虚拟账户中增加对应余额。

**2. 下注流程 (Off-chain, Gas-Free)**
- 用户在通过各种 Tick 选择后，点击"下注"。
- 钱包弹出 **EIP-712 签名请求**：
  ```json
  {
    "action": "Bet",
    "marketId": 1001,
    "tick": 5,
    "amount": 100,
    "nonce": 123
  }
  ```
- 用户签名，前端将签名发送给 **定序器 API**。
- 定序器验证余额，扣除如下注额，锁定赔率，并返回"下注成功"确认。
- **全程无 Gas 费，毫秒级响应**。

**3. 结算流程 (Off-chain Internal - Lazy Sync)**
- 用户进行高频交易（如每分钟下注），所有状态均在链下定序器中更新。
- **完全离线处理**：下注、输赢判定、余额更新均不立即上链。
- 定序器判定输赢：
  - **赢**：用户虚拟余额增加（本金 + 奖金），LP 池虚拟余额减少。
  - **输**：此笔下注资金归入 LP 池虚拟余额。
- 推送结果给前端。
- *注：此阶段用户链上余额保持不变，仅在提现时通过"最终状态"进行一次性同步。*

**4. 提现流程 (On-chain Settlement - Demand Sync)**
- 用户向定序器发起提现请求（Request to Withdraw）。
- 定序器打包用户的"最终状态"（包括累计盈利），并使用私钥签名，生成 **提现凭证 (Withdrawal Ticket)**。
  - 凭证包含：`{ 用户地址, 提现金额, 累计Nonce, 过期时间, 签名 }`
- 用户收到凭证后，发起链上交易调用 `LiquidityVault.withdraw(...)`。
- 合约验证签名有效且 Nonce 未被使用，将资金从托管池转给用户。
- 链上状态至此与链下账本完成同步。

**5. 安全保障 (Anti-Censorship)**
- 如果定序器宕机或拒绝用户提现，用户可调用合约的 `requestForceExit`。
- 如果定序器在规定时间（如 24 小时）内未提供用户已输掉资金的证明（Signed Losing Bets），合约将释放用户最后一次记录的余额或全额存款。

### 3.3 前端技术栈

-   **框架**: Next.js 14 (App Router)
-   **状态管理**: Zustand / Redux Toolkit
-   **区块链交互**: ethers.js / viem + wagmi
-   **图表库**: TradingView Lightweight Charts
-   **UI 组件库**: Tailwind CSS + shadcn/ui
-   **数据同步**: WebSocket + SWR

## 4. 数据模型

### 4.1 智能合约数据结构

```solidity
// 市场信息
struct Market {
    uint256 id;
    address asset;          // 标的资产 (如 WETH)
    uint256 startTime;      // 开始时间戳
    uint256 endTime;        // 结束时间戳
    uint256 startPrice;     // 初始锚定价格
    uint256 settlementPrice;// 最终结算价格
    MarketStatus status;    // 状态枚举: ACTIVE, SETTLED, CANCELLED
    uint256 totalVolume;    // 市场总交易量
}

// Tick 信息
struct Tick {
    int24 tickId;           // Tick 索引
    uint256 lowerBound;     // 价格下限
    uint256 upperBound;     // 价格上限
    uint256 totalBets;      // 该区间总下注额
    uint256 odds;           // 当前赔率快照
}

// 用户下注记录
struct Bet {
    uint256 marketId;
    int24 tickId;
    address user;
    uint256 amount;
    uint256 odds;           // 下注时锁定的赔率
    uint256 timestamp;
    BetStatus status;       // 状态: ACTIVE, WON, LOST, REFUNDED
}
```

### 4.2 数据库设计 (辅助查询)

为了提升前端查询速度，可使用 PostgreSQL 缓存链上数据：

-   **markets 表**: 存储市场基础信息、状态、开始/结束时间。
-   **bets 表**: 存储每笔下注的详细信息、赔率、用户地址。
-   **accounts 表**: 缓存用户的余额、充提记录和盈亏统计。

## 5. 代币经济学 (暂定)

### 5.1 治理代币 KMARK

-   **代币名称**: KMarket Token (KMARK)
-   **总供应量**: 1,000,000,000
-   **核心用途**:
    1.  **协议治理**: 投票修改交易手续费率、赔率参数等。
    2.  **质押分红**: 质押代币分享协议收入。
    3.  **交易折扣**: 持币用户享受手续费减免。

### 5.2 收益分配模型

-   **流动性提供者 (LP)**: 获得 70% 的平台收入（手续费 + 失败投注盈余）。
-   **KMARK 质押者**: 获得 20% 的平台收入作为分红。
-   **协议国库**: 保留 10% 用于后续开发、运营及风险储备。

## 7. 开发路线图

### 第一阶段: MVP 原型 (2-3 个月)
- 完成核心智能合约开发（市场、账本、赔率计算）。
- 构建基础前端界面，集成 TradingView。
- 在 Polygon Mumbai 测试网部署并进行内部测试。
- 集成 Chainlink 预言机。

### 第二阶段: 公测与审计 (1-2 个月)
- 委托专业机构进行安全审计。
- 发布公开测试网版本，启动激励性测试活动。
- 修复 Bug，优化用户体验。
- 完善开发者文档和用户指南。

### 第三阶段: 主网发布 (1 个月)
- 正式部署至 Polygon 主网。
- 注入初始流动性，启动创世挖矿活动。
- 开展市场营销，通过空投吸引早期用户。
- 建立社区治理基础。

### 第四阶段: 生态扩展 (持续)
- 增加 BTC, SOL 等更多资产类别。
- 开发移动端 App。
- 开放 API 接口，支持量化交易接入。
- 探索多链部署（Arbitrum, Optimism）。

## 8. 竞争分析

### 8.1 竞品对比
秒级/分钟级（极速
| 特性 | KMarket | Polymarket | Augur | dYdX Prediction |
| :--- | :--- | :--- | :--- | :--- |
| **核心标的** | K 线价格区间 | 社会事件结果 | 社会事件结果 | 资金费率/价格 |
| **市场周期** | 小时/天级（高频） | 事件驱动（低频） | 事件驱动（低频） | 持续性 |
| **流动性模式** | AMM 流动性池 | 订单簿模型 | AMM 流动性池 | 订单簿模型 |
| **结算依据** | 预言机自动结算 | 预言机 + 人工仲裁 | 社区人工仲裁 | 自动结算 |
| **主要网络** | Polygon | Polygon | Ethereum | dYdX Chain |

### 8.2 差异化优势

1.  **填补市场空白**: 专注于 K 线价格预测，满足交易者对价格走势的高频博弈需求。
2.  **Tick 机制创新**: 相比简单的涨/跌二元预测，区间预测提供了更丰富的策略维度。
3.  **低门槛高赔率**: 用户可以用小资金博取高赔率收益，且无需承担爆仓风险。
4.  **去中心化与透明**: 依托 Polygon 网络，所有数据上链，避免中心化交易所的暗箱操作。

## 9. 关键指标 (KPIs)

-   **总锁仓量 (TVL)**: 衡量流动性池的资金规模。
-   **日活跃用户 (DAU)**: 衡量产品的市场活跃度。
-   **日交易额 (Volume)**: 衡量市场的资金流动情况。
-   **协议收入**: 衡量项目的盈利能力。
-   **用户留存率**: 衡量产品的长期吸引力。

## 10. 总结

KMarket 不仅仅是一个预测市场，更是一个创新的金融衍生品协议。它结合了 Uniswap V3 的流动性效率和 Polymarket 的预测博弈机制，解决了现有市场中"高杠杆风险大"和"二元期权不透明"的痛点。

通过在 Polygon 链上构建低成本、高效率的交易环境，KMarket 有望吸引大量寻求新型交易机会的加密货币原生用户。虽然在流动性启动和监管合规方面面临挑战，但通过稳健的技术架构设计和合理的经济模型激励，KMarket 具备成为下一代 DeFi 爆款应用的潜力。
