# KMarket Backend 架构文档

> 基于 NestJS 的 K 线预测市场后端服务

---

## 1. 技术栈

| 层级 | 技术选型 | 说明 |
|------|----------|------|
| **框架** | NestJS + TypeScript | 企业级 Node.js 框架 |
| **数据库** | PostgreSQL | 主数据存储 |
| **ORM** | TypeORM | 对象关系映射 |
| **缓存** | Redis (可选) | 价格缓存、会话存储 |
| **认证** | JWT + Passport | 无状态认证 |
| **区块链** | ethers.js v6 | EIP-712 签名验证 |
| **实时通信** | Socket.IO | 价格推送 |
| **定时任务** | @nestjs/schedule | 结算引擎 |

---

## 2. 系统架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              KMarket Server                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│  │   Users     │  │   Chain     │  │   Market    │  │   Trade     │        │
│  │   Module    │  │   Module    │  │   Module    │  │   Module    │        │
│  │             │  │             │  │             │  │             │        │
│  │ • Auth      │  │ • Deposit   │  │ • Price WS  │  │ • Bet API   │        │
│  │ • Balance   │  │ • Withdraw  │  │ • K-Line    │  │ • Settle    │        │
│  │ • History   │  │ • Verify    │  │ • Broadcast │  │ • Odds      │        │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘        │
│         │                │                │                │               │
│  ┌──────┴────────────────┴────────────────┴────────────────┴──────┐        │
│  │                        Common Module                            │        │
│  │  Config | Guards | Filters | Decorators | DTOs | Utils          │        │
│  └─────────────────────────────────────────────────────────────────┘        │
│                                    │                                        │
│  ┌─────────────────────────────────┴─────────────────────────────────┐      │
│  │                         Infrastructure                             │      │
│  │   TypeORM (PostgreSQL)  |  Redis  |  WebSocket  |  Scheduler       │      │
│  └───────────────────────────────────────────────────────────────────┘      │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 3. 模块职责

| 模块 | 职责 | 核心功能 |
|------|------|----------|
| **Users** | 用户账户管理 | 钱包登录、余额查询、交易历史 |
| **Chain** | 链上交互 | 充值监听、提现签名、签名验证 |
| **Market** | 行情数据 | 价格订阅、K线生成、WebSocket推送 |
| **Trade** | 交易核心 | 下注处理、赔率计算、自动结算 |
| **Common** | 公共组件 | 配置、守卫、过滤器、DTO |

---

## 4. 目录结构

```
kmarket_server/
├── src/
│   ├── common/                 # 全局共享
│   │   ├── config/            # 配置
│   │   ├── decorators/        # 装饰器
│   │   ├── dto/               # 通用 DTO
│   │   ├── filters/           # 异常过滤器
│   │   └── guards/            # 认证守卫
│   │
│   ├── users/                  # 用户模块
│   ├── chain/                  # 链上模块
│   ├── market/                 # 行情模块
│   ├── trade/                  # 交易模块
│   │
│   ├── app.module.ts          # 根模块
│   └── main.ts                # 入口
│
├── docs/                       # 文档
├── .env                        # 环境变量
└── package.json
```

---

## 5. 部署架构

### 开发环境

```bash
npm run start:dev
```

### 生产部署

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│   Nginx     │────▶│  NestJS     │────▶│  PostgreSQL │
│   (SSL)     │     │  Cluster    │     │             │
└─────────────┘     └─────────────┘     └─────────────┘
                           │
                    ┌──────┴──────┐
                    ▼             ▼
              ┌──────────┐  ┌──────────┐
              │  Redis   │  │ Binance  │
              │ (Cache)  │  │   WS     │
              └──────────┘  └──────────┘
```

---

## 6. 服务端点

- **REST API**: `http://localhost:3000/api`
- **WebSocket**: `ws://localhost:3000/market`

---

## 相关文档

- [02_开发规范](./02_DEVELOPMENT_STANDARDS.md)
- 03_API接口文档 (待补充)
- 04_数据库设计 (待补充)
